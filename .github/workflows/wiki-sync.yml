name: Sync Docs to Wiki

on:
  push:
    branches: [ main ]
    paths:
      - 'Docs/**'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # needed for pushing to the wiki repo
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare staging area
        run: |
          set -euo pipefail
          rm -rf wiki-stage
          mkdir -p wiki-stage

          # Copy Docs/ into staging and normalize
          rsync -av --delete Docs/ wiki-stage/

          # Map repo Docs/main.md to wiki Home.md if present
          if [ -f wiki-stage/main.md ]; then mv -f wiki-stage/main.md "wiki-stage/Home.md"; fi

          # Generate a Sidebar: Home at the top, then all other pages sorted
          # Use Markdown links to match exact filenames, avoiding WikiLink title mismatches
          {
            echo "- [[Home]]"
            ls -1 wiki-stage/*.md 2>/dev/null | xargs -n1 basename \
              | grep -v -E '^Home\.md$|^_' \
              | sort \
              | while read -r f; do
                  title=$(echo "$f" | sed -E 's/\.md$//' | sed -E 's/[-_]+/ /g' | awk '{for(i=1;i<=NF;i++){ $i=toupper(substr($i,1,1)) substr($i,2) }}1')
                  echo "- [${title}](${f})"
                done
          } > wiki-stage/_Sidebar.md

          echo "---- Staged files (wiki-stage) ----"
          ls -la wiki-stage || true
          echo
          echo "Markdown files detected:"
          find wiki-stage -maxdepth 2 -type f -name '*.md' -print | sed 's/^/  - /'
          echo
          if ! find wiki-stage -maxdepth 1 -type f -name '*.md' | grep -q .; then
            echo "No markdown files found in Docs/. Ensure Docs/ contains .md files on the main branch."
            exit 1
          fi

      - name: Push to Wiki
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # If GITHUB_TOKEN is restricted for the Wiki in your org, create a PAT and add as WIKI_PUSH_TOKEN secret,
          # then swap the clone URL below to use it instead of GITHUB_TOKEN.
          # WIKI_PUSH_TOKEN: ${{ secrets.WIKI_PUSH_TOKEN }}
        run: |
          set -euo pipefail
          git config --global init.defaultBranch main
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Check if the Wiki feature is enabled on this repository; if not, skip gracefully
          API_URL="${GITHUB_API_URL:-https://api.github.com}"
          if ! curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
               "${API_URL}/repos/${REPO}" | grep -q '"has_wiki": *true'; then
            echo "Wiki feature is disabled for ${REPO}. Failing this job to make the requirement explicit."
            echo "Enable Wikis in Repo Settings → General → Features, then re-run."
            exit 1
          fi

          # Ensure a clean clone target to avoid residual directories across runs
          rm -rf wiki

          # Clone the wiki repository (separate .wiki repo)
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.wiki.git" wiki || {
            echo "Failed to clone wiki repository. Verify the wiki exists (create the first page) and token has access." >&2
            echo "Tip: Open the Wiki tab in GitHub and create an initial page to initialize the .wiki repo."
            exit 1
          }
          # If using PAT instead, use the following line and comment out the one above:
          # git clone "https://${WIKI_PUSH_TOKEN}@github.com/${REPO}.wiki.git" wiki

          # Sync staged content into wiki repo (delete removed files)
          rsync -av --delete wiki-stage/ wiki/

          cd wiki
          echo "---- Wiki repo status before commit ----"
          git status --porcelain=v1
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi
          git add -A
          git commit -m "Sync Docs/ to Wiki [CI]"
          git push
          echo "Last wiki commit:" && git --no-pager log -1 --oneline
