# Build Flutter web app (admin portal)
FROM ghcr.io/cirruslabs/flutter:3.24.0 AS build
WORKDIR /app

# Monorepo dependency prep (ui_kit path)
COPY packages/ui_kit/pubspec.yaml packages/ui_kit/pubspec.yaml
COPY packages/flutter_app/pubspec.yaml packages/flutter_app/pubspec.yaml
COPY packages/flutter_app/pubspec.lock packages/flutter_app/pubspec.lock
COPY packages/ui_kit/lib packages/ui_kit/lib

WORKDIR /app/packages/flutter_app
RUN flutter config --enable-web && flutter pub get

# Copy flutter_app sources
COPY packages/flutter_app .

ARG API_BASE_URL
ARG PUSH_NOTIFICATIONS_ENABLED
ARG FIREBASE_API_KEY
ARG FIREBASE_APP_ID
ARG FIREBASE_MESSAGING_SENDER_ID
ARG FIREBASE_PROJECT_ID
ARG FIREBASE_VAPID_KEY
ARG FIREBASE_AUTH_DOMAIN
ARG FIREBASE_STORAGE_BUCKET

RUN flutter build web -t lib/main_admin.dart --release --web-renderer canvaskit \
  --base-href="/" \
  --pwa-strategy=none \
  --dart-define="API_BASE_URL=${API_BASE_URL:-http://localhost:8000}" \
  --dart-define="PUSH_NOTIFICATIONS_ENABLED=${PUSH_NOTIFICATIONS_ENABLED:-false}" \
  --dart-define="FIREBASE_API_KEY=${FIREBASE_API_KEY:-}" \
  --dart-define="FIREBASE_APP_ID=${FIREBASE_APP_ID:-}" \
  --dart-define="FIREBASE_MESSAGING_SENDER_ID=${FIREBASE_MESSAGING_SENDER_ID:-}" \
  --dart-define="FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}" \
  --dart-define="FIREBASE_VAPID_KEY=${FIREBASE_VAPID_KEY:-}" \
  --dart-define="FIREBASE_AUTH_DOMAIN=${FIREBASE_AUTH_DOMAIN:-}" \
  --dart-define="FIREBASE_STORAGE_BUCKET=${FIREBASE_STORAGE_BUCKET:-}"

FROM nginx:1.27-alpine
COPY --from=build /app/packages/flutter_app/build/web /usr/share/nginx/html
COPY packages/flutter_app/nginx.default.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
